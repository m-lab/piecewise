---
- name: Fetch updated piecewise repo
  become: True
  become_user: root
  git: repo=https://github.com/opentechinstitute/piecewise.git 
       dest=/opt/piecewise.git/
       version=update-ndt-test

- name: Deploy updated piecewise code
  become: True
  become_user: root
  file: src=/opt/piecewise.git/{{ item.src }} dest=/opt/{{ item.dest }} state=link
  with_items:
      - { src: piecewise, dest: piecewise }

- name: Restart services
  become: True
  become_user: root
  service: name={{ item }} state=restarted
  with_items: 
    - uwsgi
    - nginx